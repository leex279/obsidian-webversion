services:
  setup-wizard:
    build:
      context: ./setup
      dockerfile: Dockerfile
    image: obsidian-setup-wizard:latest
    container_name: obsidian-setup-wizard
    restart: unless-stopped
    ports:
      - "3000:3000"
    volumes:
      # Mount entire project directory as workspace
      # This avoids issues with Docker creating .env as a directory
      - .:/workspace:rw

      # Docker socket access (allows docker commands from container)
      # Docker CLI is installed in the container, just needs socket access
      - /var/run/docker.sock:/var/run/docker.sock:ro
    environment:
      - NODE_ENV=production
      - PORT=3000
      - WORKSPACE_DIR=/workspace
      - SETUP_TOKEN=${SETUP_TOKEN:-}
      - DISABLE_AFTER_SETUP=${DISABLE_AFTER_SETUP:-true}
    networks:
      - obsidian_network
    healthcheck:
      test: ["CMD", "wget", "--spider", "--quiet", "http://localhost:3000/api/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s

networks:
  obsidian_network:
    driver: bridge
    name: obsidian_network
