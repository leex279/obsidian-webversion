{
	# Global options
	email {$CADDY_EMAIL}
	# Use Let's Encrypt staging for testing to avoid rate limits
	# acme_ca https://acme-staging-v02.api.letsencrypt.org/directory
}

{$DOMAIN} {
	# Security headers
	header {
		# Enable HSTS
		Strict-Transport-Security "max-age=31536000; includeSubDomains; preload"
		# Prevent clickjacking
		X-Frame-Options "SAMEORIGIN"
		# Prevent MIME sniffing
		X-Content-Type-Options "nosniff"
		# Enable XSS protection
		X-XSS-Protection "1; mode=block"
		# Referrer policy
		Referrer-Policy "strict-origin-when-cross-origin"
	}

	# Health check endpoint (bypass auth)
	handle /health {
		respond "OK" 200
	}

	# OAuth2 callback endpoint (bypass auth, needed for OAuth flow)
	handle /oauth2/callback {
		reverse_proxy oauth2-proxy:4180 {
			header_up Host {host}
			header_up X-Real-IP {remote_host}
			header_up X-Forwarded-For {remote_host}
			header_up X-Forwarded-Proto {scheme}
		}
	}

	# All other requests go through OAuth2-Proxy
	handle {
		reverse_proxy oauth2-proxy:4180 {
			header_up Host {host}
			header_up X-Real-IP {remote_host}
			header_up X-Forwarded-For {remote_host}
			header_up X-Forwarded-Proto {scheme}

			# WebSocket support for KasmVNC
			header_up Connection {>Connection}
			header_up Upgrade {>Upgrade}
		}
	}

	# Logging
	log {
		output file /data/logs/access.log {
			roll_size 10MB
			roll_keep 10
		}
		format json
	}
}
