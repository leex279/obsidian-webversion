services:
  caddy:
    image: caddy:2-alpine
    container_name: caddy-reverse-proxy
    restart: unless-stopped
    ports:
      # HTTP port for Let's Encrypt validation and auto-redirect to HTTPS
      - "80:80"
      # HTTPS port for secure access
      - "443:443"
      # HTTP/3 (QUIC) support
      - "443:443/udp"
    volumes:
      # Caddyfile configuration
      - ./Caddyfile:/etc/caddy/Caddyfile:ro
      # Persistent storage for SSL certificates and Caddy data
      - caddy_data:/data
      # Caddy configuration storage
      - caddy_config:/config
      # Log directory
      - ./logs/caddy:/data/logs
    environment:
      # Domain and email from .env file
      - DOMAIN=${DOMAIN}
      - CADDY_EMAIL=${CADDY_EMAIL}
      # Auth upstream - defaults to direct Obsidian, set to oauth2-proxy:4180 for auth
      - AUTH_UPSTREAM=${AUTH_UPSTREAM:-obsidian:8080}
    networks:
      - obsidian_network
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:2019/config/"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s
    depends_on:
      obsidian:
        condition: service_healthy

  setup-wizard:
    build:
      context: ./setup
      dockerfile: Dockerfile
    image: obsidian-setup-wizard:latest
    container_name: obsidian-setup-wizard
    restart: "no"  # Don't auto-restart - setup is one-time
    profiles:
      - setup  # Only start when explicitly requested
    expose:
      - "3000"
    volumes:
      # Mount entire project directory as workspace
      # This avoids issues with Docker creating .env as a directory
      - .:/workspace:rw

      # Docker socket access (allows docker commands from container)
      # Docker CLI is installed in the container, just needs socket access
      - /var/run/docker.sock:/var/run/docker.sock:ro
    environment:
      - NODE_ENV=production
      - PORT=3000
      - WORKSPACE_DIR=/workspace
      - SETUP_TOKEN=${SETUP_TOKEN:-}
    networks:
      - obsidian_network
    healthcheck:
      test: ["CMD", "wget", "--spider", "--quiet", "http://localhost:3000/api/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s
    # NO dependencies - setup wizard runs standalone

  oauth2-proxy:
    # Pinned to specific version for reproducible builds
    # Update: Check https://github.com/oauth2-proxy/oauth2-proxy/releases
    image: quay.io/oauth2-proxy/oauth2-proxy:v7.13.0
    container_name: obsidian-auth-proxy
    restart: unless-stopped
    profiles:
      - auth  # Only start when authentication is configured
    command:
      - --provider=oidc
      - --provider-display-name=${AUTH_PROVIDER_DISPLAY_NAME:-OIDC Provider}
      - --redirect-url=${AUTH_REDIRECT_URL}
      - --oidc-issuer-url=${AUTH_OIDC_ISSUER_URL}
      - --client-id=${AUTH_CLIENT_ID}
      - --client-secret=${AUTH_CLIENT_SECRET}
      - --cookie-secret=${AUTH_COOKIE_SECRET}
      - --cookie-secure=${AUTH_COOKIE_SECURE:-true}
      - --cookie-domain=${DOMAIN}
      - --email-domain=${AUTH_EMAIL_DOMAINS}
      - --upstream=http://obsidian:${CUSTOM_PORT:-8080}
      - --http-address=0.0.0.0:4180
      - --reverse-proxy=true
      - --pass-host-header=true
      - --set-xauthrequest=true
    expose:
      - "4180"
    networks:
      - obsidian_network
    healthcheck:
      test: ["CMD", "wget", "--spider", "--quiet", "http://localhost:4180/ping"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 15s
    depends_on:
      obsidian:
        condition: service_healthy

  obsidian:
    image: obsidian-remote:local-autorestart
    container_name: obsidian-remote
    restart: unless-stopped
    # Ports are NOT exposed to host - only accessible via Caddy reverse proxy
    expose:
      - "8080"
      - "8443"
    volumes:
      - ./vaults:/vaults
      - ./config:/config
    environment:
      # Core Settings
      - PUID=${PUID:-1000}
      - PGID=${PGID:-1000}
      - TZ=${TZ:-Etc/UTC}

      # Web Interface Configuration
      - CUSTOM_PORT=${CUSTOM_PORT:-8080}
      - CUSTOM_HTTPS_PORT=${CUSTOM_HTTPS_PORT:-8443}
      - CUSTOM_USER=${CUSTOM_USER}
      - PASSWORD=${PASSWORD}
      - SUBFOLDER=${SUBFOLDER}
      - TITLE=${TITLE:-Obsidian Remote}
      - FM_HOME=${FM_HOME:-/vaults}

      # Optional: Docker Mods
      - DOCKER_MODS=${DOCKER_MODS}
      - INSTALL_PACKAGES=${INSTALL_PACKAGES}
      - KEYBOARD=${KEYBOARD}

    healthcheck:
      test: ["CMD-SHELL", "/bin/sh -c 'if [ -z \"$$CUSTOM_USER\" ] || [ -z \"$$PASSWORD\" ]; then curl --fail http://localhost:$$CUSTOM_PORT/ || exit 1; else curl --fail --user \"$$CUSTOM_USER:$$PASSWORD\" http://localhost:$$CUSTOM_PORT/ || exit 1; fi'"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
    networks:
      - obsidian_network

# Named volumes for persistent certificate storage
volumes:
  caddy_data:
    driver: local
  caddy_config:
    driver: local

# Internal network for Caddy-Obsidian communication
networks:
  obsidian_network:
    driver: bridge
    name: obsidian_network
